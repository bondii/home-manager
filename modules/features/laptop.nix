{
  config,
  lib,
  pkgs,
  ...
}:
let
  cfg = config.pontus.features;

  internalDisplay = "00ffffffffffff0030aeb7410000000000220104a5221678230dd09f5c589527235358000000010101010101010101010101010101016140800471b03c403020360058d71000001a000000fd00283c4c4c10010a2020202020200000000f00d10a28d10a28280a0409e5370d000000fc004e5631363057554d2d4e34450a01a67020790200810015741a00000301283c0000000000003c000000008d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001090";
  fuhdHemma = "00ffffffffffff00410c04c21219000017210104b54627783be5c5ac5047a726135054230800d1c0b30095008180814081c0010101014dd000a0f0703e8030203500b9882100001a000000ff0041553032333233303036343138000000fc0050484c2033323845310a202020000000fd00303ca0a03c010a202020202020016e020320f14b0103051404131f12021190230907078301000067030c0010000078565e00a0a0a0295030203500b9882100001e023a801871382d40582c4500b9882100001e011d007251d01e206e285500b9882100001e8c0ad08a20e02d10103e9600b988210000184d6c80a070703e8030203a00b9882100001a000000000034";
  cuhdHemma = "00ffffffffffff00410c04c21219000017210104b54627783be5c5ac5047a726135054230800d1c0b30095008180814081c0010101014dd000a0f0703e8030203500b9882100001a000000ff0041553032333233303036343138000000fc0050484c2033323845310a202020000000fd00303ca0a03c010a202020202020016e020320f14b0103051404131f12021190230907078301000067030c0010000078565e00a0a0a0295030203500b9882100001e023a801871382d40582c4500b9882100001e011d007251d01e206e285500b9882100001e8c0ad08a20e02d10103e9600b988210000184d6c80a070703e8030203a00b9882100001a000000000034";
  wqhdKontor = "00ffffffffffff001e6d7b9ec3200300021f0104b57822789e09c1ae5044af260e50542108007140818081c0a9c0d1c0810001010101a6780030f2385a40b0588a00ae514100001e023a801871382d40582c4500ae514100001e000000fd00303d1e873c000a202020202020000000fc004c472048445220445148440a2002a10203197144010304902309070783010000e305c000e30605014dd000a0f0703e803020650c204a3100001a286800a0f0703e800890650c204a3100001a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e3701279030003002845b70088ff139f002f801f009f05280002000900655a0088ff139f002f8014009f05140002000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ef90";
  wqhdTony = "00ffffffffffff00410c0110f229000021220104b57722783f6465ad4f45a325145054bfef00d1c0b30095008180814081c0010101010e6900b4f038234030203a00a84f4100001a000000ff0041553032343333303130373338000000fc0050484c20343942325536393030000000fd001e4b72723c010a202020202020027a02032cf14b0103051404131f120211902309070783010000e305e301e6060701696900681a00000101304b00518300b4f038234030203a00a84f4100001a027600a0a0a0295030209804a84f4100001a565e00a0a0a0295030203500a84f4100001e000000000000000000000000000000000000000000000000000000000056701279030003015017e50008ff139f002f801f009f05280002000900bed60008ff139f002f801f009f0528000200090033b70088ff139f002f801f009f05280002000900555a0000ff139f002f801f009f0514000200090000000000000000000000000000000000000000000000000000000000000000000000000000001990";
  wqhdTobias = "00ffffffffffff00410c0010981e000007230104b57722783f6465ad4f45a325145054bfef00d1c0b30095008180814081c0010101010e6900b4f038234030203a00a84f4100001a000000ff0041553032353037303037383332000000fc0050484c20343942325535393030000000fd001e4b72723c010a20202020202002f702032cf14b0103051404131f120211902309070783010000e305e301e60607016b6b00681a00000101304b00518300b4f038234030203a00a84f4100001a027600a0a0a0295030209804a84f4100001a565e00a0a0a0295030203500a84f4100001e000000000000000000000000000000000000000000000000000000000052701279030003015017e50008ff139f002f801f009f05280002000900bed60008ff139f002f801f009f0528000200090033b70088ff139f002f801f009f05280002000900555a0000ff139f002f801f009f0514000200090000000000000000000000000000000000000000000000000000000000000000000000000000001990";
  wqhdKim = "00ffffffffffff00410c2a09c50700002e210104b57722783edc41ac5047a526115054bfef00d1c081800101010101010101010101011a6800a0f0381f4030203a00a9504100001a000000ff0041553032333436303031393839000000fc0050484c2034393950390a202020000000fd00304b1ee63c010a20202020202002c202031ef14b0103051404131f12021190230907078301000065030c002000023a801871382d40582c4500a9504100001ea073006aa0a0295008203500a9504100001a565e00a0a0a0295030203500a9504100001e000000000000000000000000000000000000000000000000000000000000000000000000000000000000006b7012790000030114555a0004ff139f002f801f009f0514000200090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006890";

  internalConfig = {
    enable = true;
    primary = true;
    mode = "1920x1200";
    rate = "60.00";
    position = "0x0";
    rotate = "normal";
  };
  uhdConfig = {
    enable = true;
    primary = true;
    mode = "3840x2160";
    rate = "60.00";
    position = "0x0";
    rotate = "normal";
  };
  wqhdConfig = {
    enable = true;
    primary = true;
    mode = "5120x1440";
    rate = "60.00";
    position = "0x0";
    rotate = "normal";
  };
  internalBottom = internalConfig // {
    position = "1600x1440";
    primary = false;
  };
in
lib.mkIf cfg.laptop (
  let
    autorandrHotplugScript = pkgs.writeShellScript "autorandr-hotplug" ''
      ${pkgs.autorandr}/bin/autorandr --change
    '';
  in
  {
    home.packages = with pkgs; [
      autorandr
      arandr
      xorg.xrandr
      xplugd
      libnotify
    ];

    systemd.user.services.xplugd = {
      Unit = {
        Description = "xplugd: autorandr on display hotplug";
        PartOf = [ "graphical-session.target" ];
        After = [ "graphical-session.target" ];
      };
      Service = {
        ExecStart = "${pkgs.xplugd}/bin/xplugd -n ${autorandrHotplugScript}";
        Restart = "on-failure";
      };
      Install.WantedBy = [ "graphical-session.target" ];
    };

    programs.autorandr = {
      enable = true;
      hooks.postswitch.notify = ''${pkgs.libnotify}/bin/notify-send "Sk√§rmprofil" "$AUTORANDR_CURRENT_PROFILE"'';

      # Fill 'profiles' after reading EDID with xrandr & autorandr --fingerprint
      profiles = {
        mobile = {
          fingerprint.eDP-1 = internalDisplay;
          config = {
            eDP-1 = internalConfig;
            DP-2.enable = false;
            DP-9.enable = false;
            DP-10.enable = false;
            DP-11.enable = false;
          };
        };

        fuhd9s = {
          fingerprint.DP-9 = fuhdHemma;
          config.DP-9 = uhdConfig;
          config.eDP-1.enable = false;
        };
        fuhd9b = {
          fingerprint.eDP-1 = internalDisplay;
          fingerprint.DP-9 = fuhdHemma;
          config.DP-9 = uhdConfig;
          config.eDP-1.enable = false;
        };
        fuhd10s = {
          fingerprint.DP-10 = fuhdHemma;
          config.DP-10 = uhdConfig;
        };
        fuhd10d = {
          fingerprint.eDP-1 = internalDisplay;
          fingerprint.DP-10 = fuhdHemma;
          config.DP-10 = uhdConfig;
          config.eDP-1.enable = false;
        };

        cuhd11s = {
          fingerprint.DP-11 = cuhdHemma;
          config.DP-11 = uhdConfig;
        };
        cuhd11d = {
          fingerprint.eDP-1 = internalDisplay;
          fingerprint.DP-11 = cuhdHemma;
          config.DP-11 = uhdConfig;
          config.eDP-1.enable = false;
        };
        cuhd12s = {
          fingerprint.DP-12 = cuhdHemma;
          config.DP-12 = uhdConfig;
        };
        cuhd12d = {
          fingerprint.eDP-1 = internalDisplay;
          fingerprint.DP-12 = cuhdHemma;
          config.DP-12 = uhdConfig;
          config.eDP-1.enable = false;
        };

        wqhdKontorS = {
          fingerprint.DP-2 = wqhdKontor;
          config.DP-2 = wqhdConfig;
        };
        wqhdKontorD = {
          fingerprint.eDP-1 = internalDisplay;
          fingerprint.DP-2 = wqhdKontor;
          config.DP-2 = wqhdConfig;
          config.eDP-1.enable = false;
        };

        wqhdTonyS = {
          fingerprint.DP-2 = wqhdTony;
          config.DP-2 = wqhdConfig;
        };
        wqhdTonyD = {
          fingerprint.eDP-1 = internalDisplay;
          fingerprint.DP-2 = wqhdTony;
          config.DP-2 = wqhdConfig;
          config.eDP-1.enable = false;
        };

        wqhdTobiasS = {
          fingerprint.DP-2 = wqhdTobias;
          config.DP-2 = wqhdConfig;
        };
        wqhdTobiasD = {
          fingerprint.eDP-1 = internalDisplay;
          fingerprint.DP-2 = wqhdTobias;
          config.DP-2 = wqhdConfig;
          config.eDP-1.enable = false;
        };

        wqhdKim = {
          fingerprint.eDP-1 = internalDisplay;
          fingerprint.DP-2 = wqhdKim;
          config.DP-2 = wqhdConfig;
          config.eDP-1 = internalBottom;
        };
      };
    };

    xsession.windowManager.i3 = {
      enable = true;
      config.startup = [
        {
          command = "${pkgs.autorandr}/bin/autorandr --change";
          always = true;
        }
      ];
    };
  }
)
